#  –¢–∞–π–Ω—ã–π –≥–æ—Å—Ç—å: –ú–∏—Å—Å–∏—è "–ò–¥–µ–∞–ª—å–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è"
#  -------------------------------------------------------------
#  v5.0  (–∏—é–ª—å-2025)
#  ‚Äì –≤–æ–ø—Ä–æ—Å –æ –ø–ª–∞—Ç–µ–∂–µ –ø–µ—Ä–µ–¥ —Ä–∞–∑–¥–µ–ª–æ–º 3
#  ‚Äì 4 –¥–æ–ø. –∫—Ä–∏—Ç–µ—Ä–∏—è –ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–∞ 6 (–î–∞/–ù–µ—Ç + –±–∞–ª–ª—ã)
#  ‚Äì –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–ø–æ–º–∏–Ω–∞–Ω–∏—è –∏–º–µ–Ω–∏ ¬´–ú–∏—Ö–∞–∏–ª¬ª ‚â• 1 —Ä–∞–∑–∞
#  ‚Äì –º–µ–Ω–µ–¥–∂–µ—Ä –º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å —á–∞—Å—Ç—è–º–∏ –ª–∏–±–æ —Å—Ä–∞–∑—É
#  ‚Äì –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è (pymorphy2) + Streamlit chat
#  -------------------------------------------------------------
import streamlit as st, re, json
from collections import deque
from typing import List, Dict

try:
    from pymorphy2 import MorphAnalyzer
    morph = MorphAnalyzer()
except ImportError:
    morph = None                      # –ø–∞–¥–∞—Ç—å –Ω–µ –±—É–¥–µ–º ‚Äì –ª–µ–º–º–∞—Ç–∏–∑–∞—Ü–∏—è off

def norm(t:str)->str:
    t = re.sub(r"[^\w\s]"," ",t.lower())
    if not morph: return re.sub(r"\s+"," ",t).strip()
    return " ".join(morph.parse(w)[0].normal_form for w in t.split())

def has_all(keys:List[str],txt:str)->bool: return all(k in txt for k in keys)
def has_any(keys:List[str],txt:str)->bool: return any(k in txt for k in keys)

# ------------ –∞–Ω–∫–µ—Ç–∞ 1-6 --------------------------------------
CRITERIA:Dict[str,Dict]=json.loads("""{
"1. –û–ë–°–õ–£–ñ–ò–í–ê–ù–ò–ï":{"weight":0.21,"items":{
 "1.1 –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ":{"w":0.02,"kw_any":["–∑–¥—Ä–∞–≤","–¥–æ–±—Ä","–ø—Ä–∏–≤–µ—Ç—Å—Ç–≤"]},
 "1.2 –ü—Ä–µ–¥—Å—Ç–∞–≤–∏–ª—Å—è":{"w":0.02,"kw_must":["–º–µ–Ω—è"],"kw_any":["–∑–æ–≤","–∑–æ–≤—É—Ç","–∏–º—è"]},
 "1.3 –ö–∞–∫ –æ–±—Ä–∞—â–∞—Ç—å—Å—è":{"w":0.03,"kw_must":["–∫–∞–∫"],"kw_any":["–æ–±—Ä–∞—â","–º–æ–∂–Ω"]},
 "1.5 –í–µ–∂–ª–∏–≤–æ—Å—Ç—å":{"w":0.05},"1.6 –ù–µ –ø–µ—Ä–µ–±–∏–≤–∞–ª":{"w":0.01},
 "1.7 –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å":{"w":0.04},"1.8 –î–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å":{"w":0.04}}},
"2. –í–´–Ø–í–õ–ï–ù–ò–ï –ü–û–¢–†–ï–ë–ù–û–°–¢–ï–ô":{"weight":0.18,"items":{
 "2.1 –¶–µ–ª—å –≤–∏–∑–∏—Ç–∞":{"w":0.02,"kw_any":["—Ü–µ–ª—å"]},
 "2.2 –ó–ü-–∫–∞—Ä—Ç–∞ –ü–°–ë":{"w":0.04,"kw_must":["–∑–∞—Ä–ø–ª–∞—Ç"],"kw_any":["–ø—Å–±","–Ω–∞—à","–±–∞–Ω–∫"]},
 "2.3 –°—É–º–º–∞/—Å—Ä–æ–∫/—Ü–µ–ª—å":{"w":0.06,"kw_all":["—Å—É–º–º","—Å—Ä–æ–∫","—Ü–µ–ª—å"]},
 "2.4 –î–æ—Ö–æ–¥":{"w":0.03,"kw_any":["–¥–æ—Ö–æ–¥","–∑–∞—Ä–∞–±–æ—Ç"]},
 "2.5 –ü—Ä–µ–¥—É–ø—Ä–µ–¥–∏–ª –æ –≤–æ–ø—Ä–æ—Å–∞—Ö":{"w":0.03,"kw_any":["–∑–∞–¥–∞–º","–Ω–µ—Å–∫–æ–ª—å–∫","—Ä—è–¥","–≤–æ–ø—Ä–æ—Å"]}}},
"3. –ü–†–ï–ó–ï–ù–¢–ê–¶–ò–Ø":{"weight":0.20,"items":{
 "3.1 8 —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π":{"w":0.08,"kw_all":["–≥—Ä–∞–∂–¥–∞–Ω—Å—Ç–≤","–≤–æ–∑—Ä–∞—Å—Ç","—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü",
  "–ø—Ä–æ–∂–∏–≤","—Ä–∞–±–æ—Ç","–æ–±—â–∏–π","—Å—Ç–∞–∂","—Ç–µ–ª–µ—Ñ–æ–Ω"]},
 "3.2 –†–∞—Å—á—ë—Ç –ø–ª–∞—Ç–µ–∂–∞":{"w":0.04,"kw_any":["–ø–ª–∞—Ç–µ–∂","–ø–ª–∞—Ç—ë–∂","–µ–∂–µ–º–µ—Å—è—á"]},
 "3.3 –ö–æ–º—Ñ–æ—Ä—Ç –ø–ª–∞—Ç–µ–∂–∞":{"w":0.04,"kw_any":["–∫–æ–º—Ñ–æ—Ä—Ç","—É–¥–æ–±–Ω","–ø–æ–¥—Ö–æ–¥"]},
 "3.4 –ê–∫—Ü–∏—è ¬´–õ—É—á—à–µ 0¬ª":{"w":0.04,"kw_must":["–ª—É—á—à"],"kw_any":["0","–Ω–æ–ª","–∞–∫—Ü"]}}},
"4. –°–û–ó–î–ê–ù–ò–ï –ó–ê–Ø–í–ö–ò":{"weight":0.05,"items":{
 "4.1 –û—Ñ–æ—Ä–º–∏—Ç—å —Å–µ–π—á–∞—Å":{"w":0.02,"kw_any":["–æ—Ñ–æ—Ä–º","—Å–µ–π—á–∞—Å","–¥–∞–≤–∞–π","–ø—Ä–µ–¥–ª–∞–≥"]},
 "4.2 –î–æ–∫—É–º–µ–Ω—Ç—ã":{"w":0.03,"kw_all":["–ø–∞—Å–ø–æ—Ä—Ç","—Å–Ω–∏–ª—Å","–¥–æ—Ö–æ–¥","—Ç—Ä—É–¥–æ–≤"]}}},
"5. –ö–†–û–°–°-–ü–†–û–î–ê–ñ–ò":{"weight":0.10,"items":{
 "5.1 –î–æ–ø. –ø—Ä–æ–¥—É–∫—Ç":{"w":0.10,"kw_any":["–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –±–∞–Ω–∫","–¥–µ–±–µ—Ç","–∫–∞—Ä—Ç–∞","—Å—Ç—Ä–∞—Ö–æ–≤"]}}},
"6. –ó–ê–í–ï–†–®–ï–ù–ò–ï":{"weight":0.15,"items":{
 "6.1 –û—Å—Ç–∞–ª–∏—Å—å –≤–æ–ø—Ä–æ—Å—ã":{"w":0.02,"kw_any":["–≤–æ–ø—Ä–æ—Å"]},
 "6.2 –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞":{"w":0.03,"kw_any":["–≤—Å—Ç—Ä–µ—á","–ø—Ä–∏–≥–ª","–ø–æ–∑–≤–æ–Ω","–ø—Ä–µ–¥–ª–∞–≥"]},
 "6.3 –¢–µ–ª–µ—Ñ–æ–Ω":{"w":0.03,"kw_any":["—Ç–µ–ª–µ—Ñ–æ–Ω","–Ω–æ–º–µ—Ä","–æ—Å—Ç–∞–≤"]},
 "6.4 –ö–æ–Ω—Ç–∞–∫—Ç—ã":{"w":0.03,"kw_any":["–∫–æ–Ω—Ç–∞–∫—Ç","—Ç–µ–ª–µ—Ñ","–Ω–æ–º–µ—Ä"]},
 "6.5 –ú–∞—Ç–µ—Ä–∏–∞–ª—ã":{"w":0.02,"kw_any":["–±—É–∫–ª–µ—Ç","–º–∞—Ç–µ—Ä–∏–∞–ª","—Ä–∞—Å—á–µ—Ç","—Ä–∞—Å—á—ë—Ç","–ø—Ä–æ—Å—á–µ—Ç","–ø—Ä–æ—Å—á—ë—Ç"]},
 "6.6 –ü—Ä–æ—â–∞–Ω–∏–µ":{"w":0.02,"kw_any":["–¥–æ —Å–≤–∏–¥–∞–Ω","–∂–¥–µ–º","–∂–¥—ë–º","—Ä–∞–¥—ã","–¥–æ–±—Ä"]}}}
}""")

# ------------ 4 –¥–æ–ø. –∫—Ä–∏—Ç–µ—Ä–∏—è –æ—Ñ–∏—Å–∞ (–ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–∞-6) ----------
EXTRA = {
 "7.1 –ö–æ–º—Ñ–æ—Ä—Ç –∑–∞–ª–∞":        "–ö–æ–º—Ñ–æ—Ä—Ç–Ω–æ—Å—Ç—å –ø–æ–º–µ—â–µ–Ω–∏—è (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞, —á–∏—Å—Ç–æ—Ç–∞, –Ω–µ—Ç –∑–∞–ø–∞—Ö–æ–≤)",
 "7.2 –¢–∏—à–∏–Ω–∞":              "–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö —à—É–º–æ–≤",
 "7.3 –í–Ω–µ—à–Ω–∏–π –≤–∏–¥":         "–î–µ–ª–æ–≤–æ–π –≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤",
 "7.4 –ê—Ç—Ä–∏–±—É—Ç—ã":            "–ù–∞–ª–∏—á–∏–µ –ø–ª–∞—Ç–∫–∞/–≥–∞–ª—Å—Ç—É–∫–∞ –∏ –±–µ–π–¥–∂–∞"
}
EXTRA_WEIGHT = 0.10        # 0.025 –∑–∞ –∫–∞–∂–¥—ã–π

MAX_ATTEMPTS = 3

# --------- –ø—Ä–æ—Ñ–∏–ª—å –∫–ª–∏–µ–Ω—Ç–∞ ------------------------------------
PROFILE = {"name":"–ú–∏—Ö–∞–∏–ª","purpose":"—Ä–µ–º–æ–Ω—Ç –∫–≤–∞—Ä—Ç–∏—Ä—ã",
           "amount":"500 000","term":"3 –≥–æ–¥–∞","income":"70 000"}

def auto_reply(q:str)->str|None:
    qn = norm(q)
    if "–∫–∞–∫" in qn and ("–æ–±—Ä–∞—â" in qn or "–º–æ–∂–Ω" in qn):
        return f"–ú–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ {PROFILE['name']}."
    if any(k in qn for k in ["—Å—É–º–º","—Å—Ä–æ–∫","—Ü–µ–ª—å"]):
        return f"{PROFILE['amount']} ‚ÇΩ –Ω–∞ {PROFILE['term']}, —Ü–µ–ª—å ‚Äì {PROFILE['purpose']}."
    if "–¥–æ—Ö–æ–¥" in qn or "–∑–∞—Ä–∞–±–æ—Ç" in qn:
        return f"–û–∫–æ–ª–æ {PROFILE['income']} ‚ÇΩ –≤ –º–µ—Å—è—Ü."
    if "–∑–∞—Ä–ø–ª–∞—Ç" in qn:
        return "–ó–∞—Ä–ø–ª–∞—Ç—É –ø–æ–ª—É—á–∞—é –≤ –¥—Ä—É–≥–æ–º –±–∞–Ω–∫–µ."
    if "–∫–æ–º—Ñ–æ—Ä—Ç" in qn or "—É–¥–æ–±–Ω" in qn or "–ø–æ–¥—Ö–æ–¥" in qn:
        return "–î–∞, –ø–ª–∞—Ç—ë–∂ –¥–ª—è –º–µ–Ω—è –∫–æ–º—Ñ–æ—Ä—Ç–µ–Ω."
    if "–¥–æ–∫—É–º–µ–Ω—Ç" in qn or "–ø–∞—Å–ø–æ—Ä—Ç" in qn:
        return "–ü–∞—Å–ø–æ—Ä—Ç, –°–ù–ò–õ–° –∏ —Å–ø—Ä–∞–≤–∫—É –æ –¥–æ—Ö–æ–¥–∞—Ö –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—é."
    if "–≤–æ–ø—Ä–æ—Å" in qn and "–æ—Å—Ç–∞–ª" in qn:
        return "–ù–µ—Ç, –±–æ–ª—å—à–µ –≤–æ–ø—Ä–æ—Å–æ–≤ –Ω–µ—Ç."
    return None

# --------- —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–µ—Å—Å–∏–∏ -----------------------------------
def init():
    if "queue" in st.session_state: return
    q = deque()
    for s,d in CRITERIA.items():           # –±–ª–æ–∫–∏ 1-6
        for c in d["items"]: q.append((s,c))
    q.append(("PAYMENT_QUESTION","pay"))   # –≤–æ–ø—Ä–æ—Å –æ –ø–ª–∞—Ç–µ–∂–µ
    for c in EXTRA: q.append(("7. –î–û–ü.","extra:"+c))
    st.session_state.queue = q
    st.session_state.sec_text = {s:"" for s in CRITERIA}
    st.session_state.score = {s:0.0 for s in CRITERIA}|{"7. –î–û–ü.":0.0}
    st.session_state.tries = {}
    st.session_state.chat=[]
    st.session_state.extra_index=0
    st.session_state.finished=False
    st.session_state.name_used=False

init()

def add(role,msg): st.session_state.chat.append((role,msg))

# --------- –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä–∏—Ç–µ—Ä–∏—è ----------------------------------
def ok(cfg,txt):
    return  (("kw_must" not in cfg or has_all(cfg["kw_must"],txt))
         and ("kw_all"  not in cfg or has_all(cfg["kw_all"], txt))
         and ("kw_any"  not in cfg or has_any(cfg["kw_any"], txt)))

# --------- –≤—ã–≤–æ–¥ –∏—Å—Ç–æ—Ä–∏–∏ --------------------------------------
st.title("–¢–∞–π–Ω—ã–π –≥–æ—Å—Ç—å: –ú–∏—Å—Å–∏—è ¬´–ò–¥–µ–∞–ª—å–Ω–∞—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è¬ª")
for r,m in st.session_state.chat: st.chat_message(r).write(m)
if not st.session_state.chat:
    add("assistant","–¢–ü: –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–æ—à—ë–ª –∫ –æ–∫–Ω—É –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.")
    st.chat_message("assistant").write(st.session_state.chat[-1][1])

# --------- –∞–≤—Ç–æ-—Å–∫–∞–Ω –±–ª–æ–∫–æ–≤ 1-6 --------------------------------
while st.session_state.queue and st.session_state.queue[0][0] in CRITERIA:
    sec,crit=st.session_state.queue[0]
    if ok(CRITERIA[sec]["items"][crit], norm(st.session_state.sec_text[sec])):
        st.session_state.score[sec]+=CRITERIA[sec]["items"][crit]["w"]
        st.session_state.queue.popleft()
    else: break

# --------- —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ ----------------------
if st.session_state.queue:
    sec, crit = st.session_state.queue[0]

    # ----- –≤–æ–ø—Ä–æ—Å –æ –ø–ª–∞—Ç–µ–∂–µ –ø–µ—Ä–µ–¥ —Ä–∞–∑–¥–µ–ª–æ–º-3 -------
    if sec=="PAYMENT_QUESTION":
        prompt = "–¢–ü: –°–∫–∞–∂–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–∫–æ–ª—å–∫–æ —è –±—É–¥—É –ø–ª–∞—Ç–∏—Ç—å –µ–∂–µ–º–µ—Å—è—á–Ω–æ?"
    elif sec=="7. –î–û–ü.":
        key=list(EXTRA.keys())[st.session_state.extra_index]
        prompt=f"–¢–ü: {EXTRA[key]}. –í—Å—ë —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –º–æ–∏–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º? –û—Ç–≤–µ—Ç—å—Ç–µ ¬´–î–∞¬ª –∏–ª–∏ ¬´–ù–µ—Ç¬ª."
    else:
        prompt=f"–¢–ü (–∫—Ä–∏—Ç. ¬´{crit}¬ª —Ä–∞–∑–¥–µ–ª–∞ ¬´{sec}¬ª): –ø—Ä–æ—à—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é."
    st.chat_message("assistant").write(prompt)

    user=st.chat_input("–û—Ç–≤–µ—Ç –º–µ–Ω–µ–¥–∂–µ—Ä–∞‚Ä¶")
    if user:
        add("user",user)
        st.session_state.name_used |= ("–º–∏—Ö–∞–∏–ª" in norm(user))
        if sec in CRITERIA:
            st.session_state.sec_text[sec]+= " "+user

        # –∞–≤—Ç–æ-–æ—Ç–≤–µ—Ç
        ar=auto_reply(user)
        if ar: add("assistant",ar)

        # ---- –æ–±—Ä–∞–±–æ—Ç–∫–∞ PAY_QUESTION (0 –≤–µ—Å) -----------
        if sec=="PAYMENT_QUESTION":
            if has_any(["–ø–ª–∞—Ç–µ–∂","–ø–ª–∞—Ç—ë–∂","–µ–∂–µ–º–µ—Å—è—á"], norm(user)):
                st.session_state.queue.popleft()                  # –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ 3-–º—É —Ä–∞–∑–¥–µ–ª—É
            else:
                add("assistant","‚ö†Ô∏è  –ù—É–∂–µ–Ω —Å–∞–º —Ä–∞–∑–º–µ—Ä –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞.")
            st.rerun()

        # ---- –æ–±—Ä–∞–±–æ—Ç–∫–∞ EXTRA --------------------------
        elif sec=="7. –î–û–ü.":
            if norm(user) in ("–¥–∞","–≤—Å–µ","–≤—Å—ë"):
                st.session_state.score["7. –î–û–ü."] += EXTRA_WEIGHT/4
            st.session_state.queue.popleft()
            st.session_state.extra_index+=1
            st.rerun()

        # ---- –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ–±—ã—á–Ω–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è --------------
        else:
            cid=f"{sec}_{crit}"
            st.session_state.tries[cid]=st.session_state.tries.get(cid,0)+1
            if ok(CRITERIA[sec]["items"][crit], norm(st.session_state.sec_text[sec])):
                st.session_state.score[sec]+=CRITERIA[sec]["items"][crit]["w"]
                st.session_state.queue.popleft()
                add("assistant","‚úÖ  –ö—Ä–∏—Ç–µ—Ä–∏–π –≤—ã–ø–æ–ª–Ω–µ–Ω, –∏–¥—ë–º –¥–∞–ª—å—à–µ.")
            else:
                if st.session_state.tries[cid]>=MAX_ATTEMPTS:
                    cfg=CRITERIA[sec]["items"][crit]
                    hint=" / ".join(cfg.get("kw_must",[])+cfg.get("kw_all",[])+cfg.get("kw_any",[]))
                    add("assistant",f"üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: –Ω—É–∂–Ω–æ —É–ø–æ–º—è–Ω—É—Ç—å: {hint}")
                else:
                    add("assistant","‚ö†Ô∏è  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —É—Ç–æ—á–Ω–∏—Ç–µ.")
            st.rerun()

# --------- —Ñ–∏–Ω–∞–ª ----------------------------------------------
if not st.session_state.finished and not st.session_state.queue:
    total_weight = sum(CRITERIA[s]["weight"] for s in CRITERIA)+EXTRA_WEIGHT
    gained = sum(st.session_state.score.values())
    # –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–º–µ–Ω–∏
    if not st.session_state.name_used:
        note="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞ –Ω–∏ —Ä–∞–∑—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ ‚Äì –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–Ω–∏–∂–µ–Ω–∞ –æ—Ü–µ–Ω–∫–∞."
        gained=max(gained-0.05,0)   # ‚Äì5 %
    else:
        note=""
    pct=round(gained/total_weight*100,1)
    verdict=("–û–¢–õ–ò–ß–ù–û" if pct>=90 else "–•–û–†–û–®–û" if pct>=75
             else "–£–î–û–í–õ–ï–¢–í–û–†–ò–¢–ï–õ–¨–ù–û" if pct>=60 else "–ù–£–ñ–ù–û –î–û–†–ê–ë–û–¢–ê–¢–¨")
    add("assistant",f"–ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: {pct}%  ‚Ä¢  –°—Ç–∞—Ç—É—Å: {verdict}")
    if note: add("assistant",f"‚ö†Ô∏è  {note}")
    st.session_state.finished=True
    st.rerun()
